<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pramaan - ZKP Attendance System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #666;
            font-size: 16px;
        }

        /* Dashboard Styles */
        .dashboard-container {
            display: none;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: #1a1d23;
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            color: rgba(255,255,255,0.8);
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .menu-item.active {
            background: rgba(102,126,234,0.2);
            color: #667eea;
            border-left: 3px solid #667eea;
        }

        .main-content {
            margin-left: 260px;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-change {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 14px;
            color: #4caf50;
        }

        /* Tables */
        .data-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-input {
            padding: 8px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            width: 250px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #666;
        }

        tr:hover {
            background: #f9f9f9;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        /* Status Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-danger {
            background: #ffebee;
            color: #c62828;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }

        /* Scholar Interface */
        .scholar-interface {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-width: 600px;
            margin: 0 auto;
        }

        .biometric-scanner {
            background: #f5f5f5;
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 60px;
            text-align: center;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .biometric-scanner:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .biometric-scanner.scanning {
            border-color: #ff9800;
            background: #fff3e0;
            animation: pulse 1s infinite;
        }

        .biometric-scanner.success {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .scanner-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        /* ZKP Visualization */
        .zkp-flow {
            background: #f0f0ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .zkp-step {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .zkp-icon {
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, #4caf50, #45a049);
        }

        .notification.error {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .notification.info {
            background: linear-gradient(45deg, #2196f3, #1976d2);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">P</div>
                <h1 class="login-title">Pramaan</h1>
                <p class="login-subtitle">Zero-Knowledge Proof Attendance System</p>
            </div>
            
            <div class="form-group">
                <label>Login As</label>
                <select id="loginType" onchange="toggleLoginForm()">
                    <option value="admin">Admin</option>
                    <option value="scholar">Scholar</option>
                </select>
            </div>
            
            <!-- Admin Login Form -->
            <form id="adminLoginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="adminUsername" placeholder="Enter username" value="admin">
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter password" value="admin123">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span>üîê</span> Login as Admin
                </button>
            </form>
            
            <!-- Scholar Login Form -->
            <form id="scholarLoginForm" style="display: none;">
                <div class="form-group">
                    <label>Scholar ID</label>
                    <input type="text" id="scholarId" placeholder="Enter your Scholar ID">
                </div>
                
                <div class="biometric-scanner" onclick="captureBiometric('login')" style="padding: 40px;">
                    <div class="scanner-icon">üëÜ</div>
                    <p>Click to Scan Biometric</p>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span>‚úì</span> Verify & Login
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span>P</span>
                    <span>Pramaan Admin</span>
                </div>
            </div>
            
            <nav class="sidebar-menu">
                <div class="menu-item active" onclick="showPage('dashboard')">
                    <span>üìä</span> Dashboard
                </div>
                <div class="menu-item" onclick="showPage('scholars')">
                    <span>üë•</span> Scholars
                </div>
                <div class="menu-item" onclick="showPage('attendance')">
                    <span>üìÖ</span> Attendance
                </div>
                <div class="menu-item" onclick="showPage('register')">
                    <span>‚ûï</span> Register Scholar
                </div>
                <div class="menu-item" onclick="showPage('reports')">
                    <span>üìà</span> Reports
                </div>
                <div class="menu-item" onclick="showPage('zkp-logs')">
                    <span>üîí</span> ZKP Logs
                </div>
                <div class="menu-item" onclick="logout()">
                    <span>üö™</span> Logout
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <span id="currentTime"></span>
                    <div class="user-avatar">A</div>
                    <span id="adminName">Admin</span>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalScholars">0</div>
                        <div class="stat-label">Total Scholars</div>
                        <div class="stat-change">+5%</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="presentToday">0</div>
                        <div class="stat-label">Present Today</div>
                        <div class="stat-change">+12%</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="avgHours">0</div>
                        <div class="stat-label">Avg. Hours Today</div>
                        <div class="stat-change">+8%</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-value" id="zkpVerifications">0</div>
                        <div class="stat-label">ZKP Verifications</div>
                        <div class="stat-change">100%</div>
                    </div>
                </div>

                <!-- Department Chart -->
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Department-wise Distribution</h3>
                    </div>
                    <canvas id="deptChart" width="400" height="200"></canvas>
                </div>

                <!-- Recent Attendance -->
                <div class="data-table" style="margin-top: 20px;">
                    <div class="table-header">
                        <h3 class="table-title">Recent Attendance</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Scholar ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Action</th>
                                <th>ZKP Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentAttendanceBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Scholars Page -->
            <div id="scholarsPage" class="page-content" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Registered Scholars</h3>
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Search scholars..." id="scholarSearch">
                            <select id="deptFilter">
                                <option value="">All Departments</option>
                                <option value="CS">Computer Science</option>
                                <option value="EE">Electrical Engineering</option>
                                <option value="ME">Mechanical Engineering</option>
                            </select>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Scholar ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Department</th>
                                <th>Supervisor</th>
                                <th>DID</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scholarsTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Register Scholar Page -->
            <div id="registerPage" class="page-content" style="display: none;">
                <div class="scholar-interface">
                    <h2>Register New Scholar</h2>
                    
                    <form id="registerScholarForm">
                        <div class="form-group">
                            <label>Scholar ID</label>
                            <input type="text" id="newScholarId" placeholder="e.g., PHD2024001" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="newScholarName" placeholder="Enter full name" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="newScholarEmail" placeholder="scholar@university.edu" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Department</label>
                            <select id="newScholarDept" required>
                                <option value="">Select Department</option>
                                <option value="CS">Computer Science</option>
                                <option value="EE">Electrical Engineering</option>
                                <option value="ME">Mechanical Engineering</option>
                                <option value="CE">Civil Engineering</option>
                                <option value="BT">Biotechnology</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Supervisor</label>
                            <input type="text" id="newScholarSupervisor" placeholder="Dr. John Doe" required>
                        </div>
                        
                        <div class="biometric-scanner" id="regBiometricScanner" onclick="captureBiometric('register')">
                            <div class="scanner-icon">üîê</div>
                            <p>Click to Capture Biometric</p>
                            <small>This will be converted to ZKP</small>
                        </div>
                        
                        <div class="zkp-flow">
                            <h4>ZKP Registration Process:</h4>
                            <div class="zkp-step">
                                <div class="zkp-icon">1</div>
                                <div>Capture biometric data</div>
                            </div>
                            <div class="zkp-step">
                                <div class="zkp-icon">2</div>
                                <div>Generate cryptographic hash</div>
                            </div>
                            <div class="zkp-step">
                                <div class="zkp-icon">3</div>
                                <div>Create DID & ZKP keys</div>
                            </div>
                            <div class="zkp-step">
                                <div class="zkp-icon">4</div>
                                <div>Store proof on blockchain</div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span>‚úì</span> Register Scholar
                        </button>
                    </form>
                </div>
            </div>

            <!-- Attendance Page -->
            <div id="attendancePage" class="page-content" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Attendance Records</h3>
                        <div class="search-box">
                            <input type="date" id="attendanceDate">
                            <input type="text" class="search-input" placeholder="Scholar ID" id="attendanceSearch">
                            <button class="btn btn-secondary" onclick="filterAttendance()">Filter</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Scholar ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Duration</th>
                                <th>ZKP Verified</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reportsPage" class="page-content" style="display: none;">
                <div class="scholar-interface">
                    <h2>Generate Reports</h2>
                    
                    <form id="reportForm">
                        <div class="form-group">
                            <label>Report Type</label>
                            <select id="reportType">
                                <option value="summary">Department Summary</option>
                                <option value="detailed">Scholar Detailed</option>
                                <option value="anomaly">Anomaly Detection</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="reportStartDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="reportEndDate" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <span>üìä</span> Generate Report
                        </button>
                    </form>
                    
                    <div id="reportOutput" style="margin-top: 30px;">
                        <!-- Report will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- ZKP Logs Page -->
            <div id="zkp-logsPage" class="page-content" style="display: none;">
                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">Zero-Knowledge Proof Verification Logs</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>DID</th>
                                <th>Purpose</th>
                                <th>Proof Hash</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="zkpLogsBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Scholar Dashboard -->
    <div id="scholarDashboard" class="dashboard-container" style="display: none;">
        <div class="main-content" style="margin-left: 0;">
            <div class="header">
                <h1 class="page-title">Scholar Portal</h1>
                <div class="user-info">
                    <span id="scholarName"></span>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>
            
            <div class="scholar-interface">
                <h2>Mark Attendance</h2>
                
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-value" id="scholarTotalDays">0</div>
                        <div class="stat-label">Total Days Present</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="scholarAvgHours">0</div>
                        <div class="stat-label">Avg. Hours/Day</div>
                    </div>
                </div>
                
                <div class="biometric-scanner" id="attendanceBiometric" onclick="markAttendance()">
                    <div class="scanner-icon">üëÜ</div>
                    <p>Click to Mark Attendance</p>
                    <small>Verify with biometric</small>
                </div>
                
                <div class="data-table" style="margin-top: 30px;">
                    <div class="table-header">
                        <h3 class="table-title">My Attendance History</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Duration</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="scholarAttendanceBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Modal Title</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Modal content goes here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = null;
        let currentUser = null;
        let capturedBiometric = null;
        const API_URL = 'http://localhost:5000/api';

        // Update time
        function updateTime() {
            const now = new Date();
            const timeElements = document.querySelectorAll('#currentTime');
            timeElements.forEach(el => {
                if (el) el.textContent = now.toLocaleString();
            });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Toggle login form
        function toggleLoginForm() {
            const loginType = document.getElementById('loginType').value;
            const adminForm = document.getElementById('adminLoginForm');
            const scholarForm = document.getElementById('scholarLoginForm');
            
            if (loginType === 'admin') {
                adminForm.style.display = 'block';
                scholarForm.style.display = 'none';
            } else {
                adminForm.style.display = 'none';
                scholarForm.style.display = 'block';
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Admin login
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            try {
                const response = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.admin;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('userRole', 'admin');
                    
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    document.getElementById('adminName').textContent = currentUser.username;
                    
                    showNotification('Login successful!', 'success');
                    loadDashboard();
                } else {
                    showNotification(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showNotification('Connection error', 'error');
            }
        });

        // Scholar login
        document.getElementById('scholarLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const scholarId = document.getElementById('scholarId').value;
            
            if (!capturedBiometric) {
                showNotification('Please scan your biometric first', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/scholar/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scholarId, biometricData: capturedBiometric })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.scholar;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('userRole', 'scholar');
                    
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('scholarDashboard').style.display = 'block';
                    document.getElementById('scholarName').textContent = currentUser.name;
                    
                    showNotification('Login successful!', 'success');
                    loadScholarDashboard();
                } else {
                    showNotification(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showNotification('Connection error', 'error');
            }
        });

        // Capture biometric
        async function captureBiometric(type) {
            const scanner = type === 'register' ? 
                document.getElementById('regBiometricScanner') : 
                (type === 'login' ? 
                    document.querySelector('#scholarLoginForm .biometric-scanner') :
                    document.getElementById('attendanceBiometric'));
            
            if (!scanner) return;
            
            scanner.classList.add('scanning');
            scanner.innerHTML = `
                <div class="loading"></div>
                <p>Scanning biometric...</p>
                <small>Processing with ZKP</small>
            `;
            
            // Simulate biometric capture
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Generate simulated biometric data
            capturedBiometric = 'bio_' + Math.random().toString(36).substr(2, 9);
            
            scanner.classList.remove('scanning');
            scanner.classList.add('success');
            scanner.innerHTML = `
                <div class="scanner-icon">‚úÖ</div>
                <p>Biometric Captured</p>
                <small>ZKP Generated</small>
            `;
            
            setTimeout(() => {
                scanner.classList.remove('success');
                scanner.innerHTML = `
                    <div class="scanner-icon">${type === 'register' ? 'üîê' : 'üëÜ'}</div>
                    <p>Click to ${type === 'register' ? 'Capture' : 'Scan'} Biometric</p>
                    <small>${type === 'register' ? 'This will be converted to ZKP' : 'Verify with biometric'}</small>
                `;
            }, 3000);
        }

        // Show page
        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
            
            // Remove active class from menu items
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            
            // Show selected page
            document.getElementById(page + 'Page').style.display = 'block';
            
            // Update active menu item
            event.target.closest('.menu-item').classList.add('active');
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'scholars': 'Scholars Management',
                'attendance': 'Attendance Records',
                'register': 'Register New Scholar',
                'reports': 'Reports & Analytics',
                'zkp-logs': 'ZKP Verification Logs'
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';
            
            // Load page data
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'scholars':
                    loadScholars();
                    break;
                case 'attendance':
                    loadAttendance();
                    break;
                case 'zkp-logs':
                    loadZKPLogs();
                    break;
            }
        }

        // Load dashboard
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_URL}/admin/dashboard`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('totalScholars').textContent = data.totalScholars;
                    document.getElementById('presentToday').textContent = data.presentToday;
                    document.getElementById('avgHours').textContent = data.avgHours;
                    document.getElementById('zkpVerifications').textContent = data.presentToday * 2; // Check-in + Check-out
                    
                    // Update recent attendance
                    const tbody = document.getElementById('recentAttendanceBody');
                    tbody.innerHTML = '';
                    
                    data.recentAttendance.forEach(record => {
                        const row = tbody.insertRow();
                        const checkInTime = new Date(record.checkIn).toLocaleTimeString();
                        const action = record.checkOut ? 'Check-out' : 'Check-in';
                        
                        row.innerHTML = `
                            <td>${checkInTime}</td>
                            <td>${record.scholarId}</td>
                            <td>${record.scholarName || 'Loading...'}</td>
                            <td>${record.department || 'CS'}</td>
                            <td><span class="badge ${record.checkOut ? 'badge-warning' : 'badge-success'}">${action}</span></td>
                            <td><span class="badge badge-success">Verified</span></td>
                        `;
                    });
                    
                    // Draw department chart (simplified)
                    drawDepartmentChart(data.departmentStats);
                }
            } catch (error) {
                showNotification('Failed to load dashboard', 'error');
            }
        }

        // Draw department chart
        function drawDepartmentChart(stats) {
            const canvas = document.getElementById('deptChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Simple bar chart
            const barWidth = width / stats.length;
            const maxCount = Math.max(...stats.map(s => s.count));
            
            stats.forEach((stat, index) => {
                const barHeight = (stat.count / maxCount) * (height - 40);
                const x = index * barWidth + 20;
                const y = height - barHeight - 20;
                
                // Draw bar
                ctx.fillStyle = '#667eea';
                ctx.fillRect(x, y, barWidth - 40, barHeight);
                
                // Draw label
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(stat._id, x + (barWidth - 40) / 2, height - 5);
                ctx.fillText(stat.count, x + (barWidth - 40) / 2, y - 5);
            });
        }

        // Load scholars
        async function loadScholars() {
            try {
                const search = document.getElementById('scholarSearch').value;
                const dept = document.getElementById('deptFilter').value;
                
                let url = `${API_URL}/admin/scholars?`;
                if (search) url += `search=${search}&`;
                if (dept) url += `department=${dept}&`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('scholarsTableBody');
                    tbody.innerHTML = '';
                    
                    data.scholars.forEach(scholar => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${scholar.scholarId}</td>
                            <td>${scholar.name}</td>
                            <td>${scholar.email}</td>
                            <td>${scholar.department}</td>
                            <td>${scholar.supervisor}</td>
                            <td title="${scholar.did}">${scholar.did.substring(0, 20)}...</td>
                            <td><span class="badge badge-success">${scholar.status}</span></td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewScholarDetails('${scholar._id}')">View</button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                showNotification('Failed to load scholars', 'error');
            }
        }

        // Register scholar
        document.getElementById('registerScholarForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!capturedBiometric) {
                showNotification('Please capture biometric data first', 'error');
                return;
            }
            
            const scholarData = {
                scholarId: document.getElementById('newScholarId').value,
                name: document.getElementById('newScholarName').value,
                email: document.getElementById('newScholarEmail').value,
                department: document.getElementById('newScholarDept').value,
                supervisor: document.getElementById('newScholarSupervisor').value,
                biometricData: capturedBiometric
            };
            
            try {
                const response = await fetch(`${API_URL}/scholar/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scholarData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('Scholar registered successfully!', 'success');
                    document.getElementById('registerScholarForm').reset();
                    capturedBiometric = null;
                    
                    // Show DID in modal
                    showModal('Registration Successful', `
                        <div class="zkp-flow">
                            <h4>Scholar registered with ZKP:</h4>
                            <p><strong>Scholar ID:</strong> ${data.scholarId}</p>
                            <p><strong>DID:</strong> ${data.did}</p>
                            <p><strong>ZKP Public Key:</strong> ${data.zkpPublicKey}</p>
                            <p style="margin-top: 20px;">The scholar can now use their biometric to mark attendance securely.</p>
                        </div>
                    `);
                } else {
                    showNotification(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showNotification('Connection error', 'error');
            }
        });

        // Load attendance
        async function loadAttendance() {
            try {
                const date = document.getElementById('attendanceDate').value;
                const scholarId = document.getElementById('attendanceSearch').value;
                
                let url = `${API_URL}/admin/attendance?`;
                if (date) url += `date=${date}&`;
                if (scholarId) url += `scholarId=${scholarId}&`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('attendanceTableBody');
                    tbody.innerHTML = '';
                    
                    data.attendance.forEach(record => {
                        const row = tbody.insertRow();
                        const checkIn = new Date(record.checkIn);
                        const checkOut = record.checkOut ? new Date(record.checkOut) : null;
                        const duration = record.duration ? record.duration.toFixed(2) + ' hrs' : '-';
                        
                        row.innerHTML = `
                            <td>${checkIn.toLocaleDateString()}</td>
                            <td>${record.scholarId}</td>
                            <td>${record.scholarName}</td>
                            <td>${record.department}</td>
                            <td>${checkIn.toLocaleTimeString()}</td>
                            <td>${checkOut ? checkOut.toLocaleTimeString() : '-'}</td>
                            <td>${duration}</td>
                            <td><span class="badge badge-success">‚úì Verified</span></td>
                        `;
                    });
                }
            } catch (error) {
                showNotification('Failed to load attendance', 'error');
            }
        }

        // Filter attendance
        function filterAttendance() {
            loadAttendance();
        }

        // Generate report
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            try {
                const response = await fetch(`${API_URL}/admin/reports?type=${reportType}&startDate=${startDate}&endDate=${endDate}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayReport(data, reportType);
                }
            } catch (error) {
                showNotification('Failed to generate report', 'error');
            }
        });

        // Display report
        function displayReport(data, type) {
            const output = document.getElementById('reportOutput');
            
            if (type === 'summary') {
                let html = '<h3>Department Summary Report</h3>';
                html += '<table class="data-table" style="margin-top: 20px;">';
                html += '<tr><th>Department</th><th>Total Sessions</th><th>Total Hours</th><th>Unique Scholars</th><th>Avg Hours/Session</th></tr>';
                
                data.summary.forEach(dept => {
                    html += `<tr>
                        <td>${dept.department}</td>
                        <td>${dept.totalSessions}</td>
                        <td>${dept.totalHours}</td>
                        <td>${dept.uniqueScholars}</td>
                        <td>${dept.avgHoursPerSession}</td>
                    </tr>`;
                });
                
                html += '</table>';
                output.innerHTML = html;
            } else if (type === 'detailed') {
                let html = '<h3>Scholar Detailed Report</h3>';
                html += '<div style="max-height: 400px; overflow-y: auto;">';
                
                Object.entries(data.scholarStats).forEach(([scholarId, stats]) => {
                    html += `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
                            <h4>${scholarId}</h4>
                            <p>Total Days: ${stats.totalDays}</p>
                            <p>Total Hours: ${stats.totalHours.toFixed(2)}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
                output.innerHTML = html;
            }
        }

        // Load ZKP logs
        async function loadZKPLogs() {
            // Simulated ZKP logs
            const logs = [
                {
                    timestamp: new Date().toISOString(),
                    did: 'did:pramaan:a665a45920422f9d',
                    purpose: 'attendance',
                    proofHash: '0x' + Math.random().toString(36).substr(2, 16),
                    status: 'verified'
                },
                {
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    did: 'did:pramaan:97a6d21df7c51e82',
                    purpose: 'registration',
                    proofHash: '0x' + Math.random().toString(36).substr(2, 16),
                    status: 'verified'
                }
            ];
            
            const tbody = document.getElementById('zkpLogsBody');
            tbody.innerHTML = '';
            
            logs.forEach(log => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td title="${log.did}">${log.did.substring(0, 20)}...</td>
                    <td>${log.purpose}</td>
                    <td>${log.proofHash}</td>
                    <td><span class="badge badge-success">${log.status}</span></td>
                    <td><button class="btn btn-secondary" onclick="viewZKPDetails('${log.proofHash}')">View</button></td>
                `;
            });
        }

        // Scholar Dashboard Functions
        async function loadScholarDashboard() {
            try {
                const response = await fetch(`${API_URL}/scholar/attendance-history`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Calculate stats
                    const totalDays = data.attendance.length;
                    let totalHours = 0;
                    let completedDays = 0;
                    
                    data.attendance.forEach(record => {
                        if (record.duration > 0) {
                            totalHours += record.duration;
                            completedDays++;
                        }
                    });
                    
                    const avgHours = completedDays > 0 ? (totalHours / completedDays).toFixed(2) : 0;
                    
                    document.getElementById('scholarTotalDays').textContent = totalDays;
                    document.getElementById('scholarAvgHours').textContent = avgHours;
                    
                    // Update attendance history
                    const tbody = document.getElementById('scholarAttendanceBody');
                    tbody.innerHTML = '';
                    
                    data.attendance.slice(0, 10).forEach(record => {
                        const row = tbody.insertRow();
                        const checkIn = new Date(record.checkIn);
                        const checkOut = record.checkOut ? new Date(record.checkOut) : null;
                        const duration = record.duration ? record.duration.toFixed(2) + ' hrs' : '-';
                        const status = record.checkOut ? 'Completed' : 'In Progress';
                        
                        row.innerHTML = `
                            <td>${checkIn.toLocaleDateString()}</td>
                            <td>${checkIn.toLocaleTimeString()}</td>
                            <td>${checkOut ? checkOut.toLocaleTimeString() : '-'}</td>
                            <td>${duration}</td>
                            <td><span class="badge ${record.checkOut ? 'badge-success' : 'badge-warning'}">${status}</span></td>
                        `;
                    });
                }
            } catch (error) {
                showNotification('Failed to load dashboard', 'error');
            }
        }

        // Mark attendance
        async function markAttendance() {
            if (!currentUser) return;
            
            const scanner = document.getElementById('attendanceBiometric');
            scanner.classList.add('scanning');
            scanner.innerHTML = `
                <div class="loading"></div>
                <p>Verifying with ZKP...</p>
                <small>Please wait</small>
            `;
            
            // Simulate biometric capture
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            try {
                const response = await fetch(`${API_URL}/attendance/mark`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        scholarId: currentUser.scholarId,
                        biometricData: 'bio_' + Math.random().toString(36).substr(2, 9),
                        location: 'Main Campus'
                    })
                });
                
                const data = await response.json();
                
                scanner.classList.remove('scanning');
                
                if (response.ok) {
                    scanner.classList.add('success');
                    scanner.innerHTML = `
                        <div class="scanner-icon">‚úÖ</div>
                        <p>${data.message}</p>
                        <small>${data.duration || ''}</small>
                    `;
                    
                    showNotification(data.message, 'success');
                    
                    setTimeout(() => {
                        scanner.classList.remove('success');
                        scanner.innerHTML = `
                            <div class="scanner-icon">üëÜ</div>
                            <p>Click to Mark Attendance</p>
                            <small>Verify with biometric</small>
                        `;
                        loadScholarDashboard();
                    }, 3000);
                } else {
                    scanner.innerHTML = `
                        <div class="scanner-icon">‚ùå</div>
                        <p>Verification Failed</p>
                        <small>${data.error}</small>
                    `;
                    
                    showNotification(data.error || 'Failed to mark attendance', 'error');
                    
                    setTimeout(() => {
                        scanner.innerHTML = `
                            <div class="scanner-icon">üëÜ</div>
                            <p>Click to Mark Attendance</p>
                            <small>Verify with biometric</small>
                        `;
                    }, 3000);
                }
            } catch (error) {
                showNotification('Connection error', 'error');
                scanner.classList.remove('scanning');
                scanner.innerHTML = `
                    <div class="scanner-icon">üëÜ</div>
                    <p>Click to Mark Attendance</p>
                    <small>Verify with biometric</small>
                `;
            }
        }

        // Show modal
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // View scholar details
        function viewScholarDetails(scholarId) {
            showModal('Scholar Details', `
                <div class="zkp-flow">
                    <p>Loading scholar details...</p>
                </div>
            `);
        }

        // View ZKP details
        function viewZKPDetails(proofHash) {
            showModal('ZKP Verification Details', `
                <div class="zkp-flow">
                    <h4>Proof Details:</h4>
                    <p><strong>Hash:</strong> ${proofHash}</p>
                    <p><strong>Algorithm:</strong> Groth16</p>
                    <p><strong>Circuit:</strong> BiometricVerification</p>
                    <p><strong>Public Inputs:</strong> DID, Timestamp</p>
                    <p><strong>Verification Time:</strong> 0.12s</p>
                    <p style="margin-top: 20px;">
                        <span class="badge badge-success">‚úì Proof Valid</span>
                    </p>
                </div>
            `);
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userRole');
            authToken = null;
            currentUser = null;
            
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('scholarDashboard').style.display = 'none';
            
            showNotification('Logged out successfully', 'info');
        }

        // Check existing session
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('authToken');
            const userRole = localStorage.getItem('userRole');
            
            if (savedToken) {
                authToken = savedToken;
                
                if (userRole === 'admin') {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    loadDashboard();
                } else if (userRole === 'scholar') {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('scholarDashboard').style.display = 'block';
                    loadScholarDashboard();
                }
            }
        });

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Search functionality
        document.getElementById('scholarSearch').addEventListener('input', loadScholars);
        document.getElementById('deptFilter').addEventListener('change', loadScholars);
    </script>
</body>
</html>